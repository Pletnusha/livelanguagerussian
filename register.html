        <!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrazione - Livelanguage Russian</title>
    
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LecDGcsAAAAAKhBMlFk7ihhOZknno66lgb7uSGU"></script>
    
    <style>
        /* MINIMAL STYLING - Replace with your Figma design */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .phone-input {
            display: flex;
            gap: 10px;
        }
        
        .phone-input select {
            width: 100px;
        }
        
        .phone-input input {
            flex: 1;
        }
        
        .checkbox-group {
            margin-bottom: 15px;
        }
        
        .checkbox-item {
            margin-bottom: 10px;
        }
        
        .checkbox-item input {
            margin-right: 8px;
        }
        
        .privacy-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        
        .privacy-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .privacy-checkbox {
            margin-bottom: 15px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .error {
            color: red;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .required {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Registrazione</h1>
    
    <div id="successMessage" class="success" style="display: none;">
        <strong>Registrazione completata!</strong>
        <p>Controlla la tua email per le credenziali di accesso.</p>
    </div>
    
    <form id="registrationForm">
        <!-- Nome -->
        <div class="form-group">
            <label for="firstName">Nome <span class="required">*</span></label>
            <input type="text" id="firstName" name="firstName" required>
            <div id="firstNameError" class="error"></div>
        </div>
        
        <!-- Cognome -->
        <div class="form-group">
            <label for="lastName">Cognome <span class="required">*</span></label>
            <input type="text" id="lastName" name="lastName" required>
            <div id="lastNameError" class="error"></div>
        </div>
        
        <!-- Email -->
        <div class="form-group">
            <label for="email">E-mail <span class="required">*</span></label>
            <input type="email" id="email" name="email" required>
            <div id="emailError" class="error"></div>
        </div>
        
        <!-- WhatsApp Phone -->
        <div class="form-group">
            <label for="whatsappPhone">WhatsApp Phone Number <span class="required">*</span></label>
            <div class="phone-input">
                <select id="countryCode">
                    <option value="+39" selected>IT +39</option>
                    <option value="+1">US +1</option>
                    <option value="+44">UK +44</option>
                    <option value="+33">FR +33</option>
                    <option value="+49">DE +49</option>
                    <option value="+7">RU +7</option>
                </select>
                <input type="text" id="whatsappPhone" name="whatsappPhone" placeholder="3XX XXX XXXX" required>
            </div>
            <div id="phoneError" class="error"></div>
        </div>
        
        <!-- Livello -->
        <div class="form-group">
            <label for="trackLevel">Livello <span class="required">*</span></label>
            <select id="trackLevel" name="trackLevel" required>
                <option value="">-- Seleziona il tuo livello --</option>
                <option value="principianti">Principianti</option>
                <option value="livello_elementare">Livello elementare</option>
                <option value="livello_di_base">Livello di base</option>
            </select>
            <div id="levelError" class="error"></div>
        </div>
        
        <!-- Courses -->
        <div class="form-group">
            <label>Sarei interessato/interessata <span class="required">*</span></label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="course1" name="courses" value="Verbi di moto">
                    <label for="course1">Verbi di moto</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="course2" name="courses" value="Date e gli orari">
                    <label for="course2">Date e gli orari</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="course3" name="courses" value="Verbi di moto con prefissi">
                    <label for="course3">Verbi di moto con prefissi</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="course4" name="courses" value="Casi e complementi">
                    <label for="course4">Casi e complementi</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="course5" name="courses" value="Lezioni individuali">
                    <label for="course5">Lezioni individuali</label>
                </div>
            </div>
            <div id="coursesError" class="error"></div>
        </div>
        
        <!-- Privacy Section -->
        <div class="privacy-section">
            <div class="privacy-text">
                <p>
                    Livelanguage_russian is committed to protecting and respecting your privacy, 
                    and we'll only use your personal information to administer your account and to 
                    provide the products and services you requested from us. From time to time, we 
                    would like to contact you about our products and services, as well as other 
                    content that may be of interest to you.
                </p>
            </div>
            
            <!-- Marketing Consent -->
            <div class="privacy-checkbox">
                <input type="checkbox" id="marketingConsent" name="marketingConsent" required>
                <label for="marketingConsent">
                    I agree to receive other communications from Livelanguage_russian. <span class="required">*</span>
                </label>
            </div>
            
            <!-- Data Processing Consent -->
            <div class="privacy-checkbox">
                <input type="checkbox" id="dataConsent" name="dataConsent" required>
                <label for="dataConsent">
                    I agree to allow Livelanguage_russian to store and process my personal data. <span class="required">*</span>
                </label>
            </div>
            
            <div class="privacy-text">
                <p>
                    You can unsubscribe from these communications at any time. For more information 
                    on how to unsubscribe, our privacy practices, and how we are committed to 
                    protecting and respecting your privacy, please review our 
                    <a href="/privacy-policy.html" target="_blank">Privacy Policy</a>.
                </p>
            </div>
        </div>
        
        <!-- reCAPTCHA -->
        <div class="form-group" style="margin-top: 20px;">

            <div class="g-recaptcha" data-sitekey="6LfYEGcsAAAAAPyXNBwyYDsozFk7OMK6e2P_eqDW"></div>
            <div id="recaptchaError" class="error"></div>
        </div>
        
        <!-- Submit Button -->
        <div class="form-group">
            <button type="submit" id="submitBtn">Registrati</button>
        </div>
    </form>
    
    <div class="loading" id="loadingMessage">
        <p>Registrazione in corso...</p>
    </div>
    
    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://itjjgblqdpopzoxqeufd.supabase.co';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEYeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ampnYmxxZHBvcHpveHFldWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MTY5OTUsImV4cCI6MjA4NjE5Mjk5NX0.hIcwr45dq4ApcAWH6dP_ZyE9UA7XXQ2jvuEAD1YR5Mc'; // Replace with your actual anon key
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ============================================
        // PASSWORD GENERATOR
        // ============================================
        function generatePassword(length = 12) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < length; i++) {
                const randomIndex = Math.floor(Math.random() * charset.length);
                password += charset[randomIndex];
            }
            return password;
        }
        
        // ============================================
        // FORM VALIDATION
        // ============================================
        function clearErrors() {
            document.querySelectorAll('.error').forEach(el => el.textContent = '');
        }
        
        function validateForm() {
            clearErrors();
            let isValid = true;
            
            // Validate first name
            const firstName = document.getElementById('firstName').value.trim();
            if (!firstName) {
                document.getElementById('firstNameError').textContent = 'Il nome è obbligatorio';
                isValid = false;
            }
            
            // Validate last name
            const lastName = document.getElementById('lastName').value.trim();
            if (!lastName) {
                document.getElementById('lastNameError').textContent = 'Il cognome è obbligatorio';
                isValid = false;
            }
            
            // Validate email
            const email = document.getElementById('email').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email) {
                document.getElementById('emailError').textContent = "L'email è obbligatoria";
                isValid = false;
            } else if (!emailRegex.test(email)) {
                document.getElementById('emailError').textContent = 'Email non valida';
                isValid = false;
            }
            
            // Validate phone
            const phone = document.getElementById('whatsappPhone').value.trim();
            if (!phone) {
                document.getElementById('phoneError').textContent = 'Il numero WhatsApp è obbligatorio';
                isValid = false;
            }
            
            // Validate level
            const level = document.getElementById('trackLevel').value;
            if (!level) {
                document.getElementById('levelError').textContent = 'Seleziona un livello';
                isValid = false;
            }
            
            // Validate courses (at least one checked)
            const courses = document.querySelectorAll('input[name="courses"]:checked');
            if (courses.length === 0) {
                document.getElementById('coursesError').textContent = 'Seleziona almeno un corso';
                isValid = false;
            }
            
            // Validate reCAPTCHA
            const recaptchaResponse = grecaptcha.getResponse();
            if (!recaptchaResponse) {
                document.getElementById('recaptchaError').textContent = 'Completa il reCAPTCHA';
                isValid = false;
            }
            
            return isValid;
        }
        
        // ============================================
        // FORM SUBMISSION
        // ============================================
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            // Show loading
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            
            // Collect form data
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const countryCode = document.getElementById('countryCode').value;
            const whatsappPhone = countryCode + document.getElementById('whatsappPhone').value.trim();
            const trackLevel = document.getElementById('trackLevel').value;
            const marketingConsent = document.getElementById('marketingConsent').checked;
            const dataConsent = document.getElementById('dataConsent').checked;
            
            // Collect selected courses
            const courses = Array.from(document.querySelectorAll('input[name="courses"]:checked'))
                .map(cb => cb.value);
            
            // Generate password
            const generatedPassword = generatePassword();
            
            try {
                // Sign up with Supabase Auth
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: generatedPassword,
                    options: {
                        data: {
                            first_name: firstName,
                            last_name: lastName,
                            whatsapp_phone: whatsappPhone,
                            track_level: trackLevel,
                            courses: courses,
                            marketing_consent: marketingConsent,
                            data_processing_consent: dataConsent,
                            generated_password: generatedPassword
                        }
                    }
                });
                
                if (error) {
                    throw error;
                }
                
                // Success!
                console.log('User registered:', data);
                
                // Show success message
                document.getElementById('registrationForm').style.display = 'none';
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                
                // n8n will receive the webhook and send email with credentials
                // The trigger function in Supabase will create the profile automatically
                
            } catch (error) {
                console.error('Registration error:', error);
                alert('Errore durante la registrazione: ' + error.message);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
            }
        });
    </script>
</body>
</html>
