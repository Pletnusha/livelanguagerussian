<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accedi - Livelanguage Russian</title>

    <!-- Supabase JS SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>

    <!-- Google reCAPTCHA v3 (used only for registration) -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LecDGcsAAAAAKhBMIFk7ihhOZknno66lgb7uSGU"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            margin-top: 40px;
        }

        h1 {
            margin-bottom: 8px;
        }

        .mode-switch {
            margin-bottom: 28px;
            font-size: 14px;
            color: #555;
        }

        .mode-switch a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .mode-switch a:hover {
            text-decoration: underline;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .phone-input {
            display: flex;
            gap: 10px;
        }

        .phone-input select {
            width: 100px;
        }

        .phone-input input {
            flex: 1;
        }

        .checkbox-group {
            margin-bottom: 15px;
        }

        .checkbox-item {
            margin-bottom: 10px;
        }

        .checkbox-item input {
            margin-right: 8px;
        }

        .privacy-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .privacy-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .privacy-checkbox {
            margin-bottom: 15px;
        }

        button[type="submit"] {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        button[type="submit"]:hover {
            background: #0056b3;
        }

        button[type="submit"]:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error {
            color: red;
            font-size: 14px;
            margin-top: 5px;
        }

        .error-banner {
            color: red;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .required {
            color: red;
        }

        .recaptcha-badge {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }

        /* Nascondi le sezioni inattive */
        #loginSection,
        #registerSection {
            display: none;
        }
    </style>
</head>
<body>

    <!-- ============================================================ -->
    <!-- LOGIN -->
    <!-- ============================================================ -->
    <div id="loginSection">
        <h1>Accedi</h1>
        <p class="mode-switch">Non hai un account? <a href="auth.html?mode=register">Registrati</a></p>

        <div id="loginSuccess" class="success">
            <p>Login effettuato! Reindirizzamento in corso...</p>
        </div>

        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">E-mail</label>
                <input type="email" id="loginEmail" required>
            </div>

            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" required>
            </div>

            <div class="form-group">
                <button type="submit" id="loginBtn">Accedi</button>
            </div>

            <div id="loginError" class="error-banner"></div>
        </form>
    </div>

    <!-- ============================================================ -->
    <!-- REGISTER -->
    <!-- ============================================================ -->
    <div id="registerSection">
        <h1>Registrazione</h1>
        <p class="mode-switch">Hai già un account? <a href="auth.html?mode=login">Accedi</a></p>

        <div id="registerSuccess" class="success">
            <strong>Registrazione completata!</strong>
            <p>Controlla la tua email per le credenziali di accesso.</p>
        </div>

        <form id="registrationForm">
            <div class="form-group">
                <label for="firstName">Nome <span class="required">*</span></label>
                <input type="text" id="firstName" name="firstName" required>
                <div id="firstNameError" class="error"></div>
            </div>

            <div class="form-group">
                <label for="lastName">Cognome <span class="required">*</span></label>
                <input type="text" id="lastName" name="lastName" required>
                <div id="lastNameError" class="error"></div>
            </div>

            <div class="form-group">
                <label for="registerEmail">E-mail <span class="required">*</span></label>
                <input type="email" id="registerEmail" name="email" required>
                <div id="emailError" class="error"></div>
            </div>

            <div class="form-group">
                <label for="whatsappPhone">WhatsApp Phone Number <span class="required">*</span></label>
                <div class="phone-input">
                    <select id="countryCode">
                        <option value="+39" selected>IT +39</option>
                        <option value="+1">US +1</option>
                        <option value="+44">UK +44</option>
                        <option value="+33">FR +33</option>
                        <option value="+49">DE +49</option>
                        <option value="+7">RU +7</option>
                    </select>
                    <input type="text" id="whatsappPhone" name="whatsappPhone" placeholder="3XX XXX XXXX" required>
                </div>
                <div id="phoneError" class="error"></div>
            </div>

            <div class="form-group">
                <label for="trackLevel">Livello <span class="required">*</span></label>
                <select id="trackLevel" name="trackLevel" required>
                    <option value="">-- Seleziona il tuo livello --</option>
                    <option value="principianti">Principianti</option>
                    <option value="livello_elementare">Livello elementare</option>
                    <option value="livello_di_base">Livello di base</option>
                </select>
                <div id="levelError" class="error"></div>
            </div>

            <div class="form-group">
                <label>Sarei interessato/interessata <span class="required">*</span></label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="course1" name="courses" value="Verbi di moto">
                        <label for="course1">Verbi di moto</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="course2" name="courses" value="Date e gli orari">
                        <label for="course2">Date e gli orari</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="course3" name="courses" value="Verbi di moto con prefissi">
                        <label for="course3">Verbi di moto con prefissi</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="course4" name="courses" value="Casi e complementi">
                        <label for="course4">Casi e complementi</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="course5" name="courses" value="Lezioni individuali">
                        <label for="course5">Lezioni individuali</label>
                    </div>
                </div>
                <div id="coursesError" class="error"></div>
            </div>

            <div class="privacy-section">
                <div class="privacy-text">
                    <p>
                        Livelanguage_russian is committed to protecting and respecting your privacy,
                        and we'll only use your personal information to administer your account and to
                        provide the products and services you requested from us. From time to time, we
                        would like to contact you about our products and services, as well as other
                        content that may be of interest to you.
                    </p>
                </div>

                <div class="privacy-checkbox">
                    <input type="checkbox" id="marketingConsent" name="marketingConsent" required>
                    <label for="marketingConsent">
                        I agree to receive other communications from Livelanguage_russian. <span class="required">*</span>
                    </label>
                </div>

                <div class="privacy-checkbox">
                    <input type="checkbox" id="dataConsent" name="dataConsent" required>
                    <label for="dataConsent">
                        I agree to allow Livelanguage_russian to store and process my personal data. <span class="required">*</span>
                    </label>
                </div>

                <div class="privacy-text">
                    <p>
                        You can unsubscribe from these communications at any time. For more information
                        on how to unsubscribe, our privacy practices, and how we are committed to
                        protecting and respecting your privacy, please review our
                        <a href="/privacy-policy.html" target="_blank">Privacy Policy</a>.
                    </p>
                </div>
            </div>

            <div class="recaptcha-badge">
                This site is protected by reCAPTCHA and the Google
                <a href="https://policies.google.com/privacy">Privacy Policy</a> and
                <a href="https://policies.google.com/terms">Terms of Service</a> apply.
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <button type="submit" id="submitBtn">Registrati</button>
            </div>
        </form>

        <div class="loading" id="loadingMessage">
            <p>Registrazione in corso...</p>
        </div>
    </div>

    <script>
        // ============================================================
        // SUPABASE
        // ============================================================
        const SUPABASE_URL = 'https://itjjgblqdpopzoxqeufd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ampnYmxxZHBvcHpveHFldWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MTY5OTUsImV4cCI6MjA4NjE5Mjk5NX0.hIcwr45dq4ApcAWH6dP_ZyE9UA7XXQ2jvuEAD1YR5Mc';
        const RECAPTCHA_SITE_KEY = '6LecDGcsAAAAAKhBMIFk7ihhOZknno66lgb7uSGU';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================================
        // ROUTING: legge ?mode= e mostra la sezione corretta
        // ============================================================
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'login';
        const redirectPath = urlParams.get('redirect') || '';
        const topicPath = urlParams.get('topic') || '';

        if (mode === 'register') {
            document.getElementById('registerSection').style.display = 'block';
            document.title = 'Registrazione - Livelanguage Russian';
        } else {
            document.getElementById('loginSection').style.display = 'block';
            document.title = 'Accedi - Livelanguage Russian';
        }

        // ============================================================
        // LOGIN
        // ============================================================
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                document.getElementById('loginError').style.display = 'none';
                document.getElementById('loginBtn').disabled = true;

                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                try {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

                    if (error) throw error;

                    loginForm.style.display = 'none';
                    document.getElementById('loginSuccess').style.display = 'block';

                    setTimeout(() => {
                        window.location.href = redirectPath ? '/' + redirectPath + '/' : '/';
                    }, 1000);

                } catch (err) {
                    document.getElementById('loginError').textContent = 'Email o password non validi';
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('loginBtn').disabled = false;
                }
            });
        }

        // ============================================================
        // REGISTER
        // ============================================================
        function generatePassword(length = 12) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset[Math.floor(Math.random() * charset.length)];
            }
            return password;
        }

        function clearErrors() {
            document.querySelectorAll('#registerSection .error').forEach(el => el.textContent = '');
        }

        function validateForm() {
            clearErrors();
            let isValid = true;

            if (!document.getElementById('firstName').value.trim()) {
                document.getElementById('firstNameError').textContent = 'Il nome è obbligatorio';
                isValid = false;
            }
            if (!document.getElementById('lastName').value.trim()) {
                document.getElementById('lastNameError').textContent = 'Il cognome è obbligatorio';
                isValid = false;
            }

            const email = document.getElementById('registerEmail').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email) {
                document.getElementById('emailError').textContent = "L'email è obbligatoria";
                isValid = false;
            } else if (!emailRegex.test(email)) {
                document.getElementById('emailError').textContent = 'Email non valida';
                isValid = false;
            }

            if (!document.getElementById('whatsappPhone').value.trim()) {
                document.getElementById('phoneError').textContent = 'Il numero WhatsApp è obbligatorio';
                isValid = false;
            }
            if (!document.getElementById('trackLevel').value) {
                document.getElementById('levelError').textContent = 'Seleziona un livello';
                isValid = false;
            }
            if (document.querySelectorAll('input[name="courses"]:checked').length === 0) {
                document.getElementById('coursesError').textContent = 'Seleziona almeno un corso';
                isValid = false;
            }

            return isValid;
        }

        const registrationForm = document.getElementById('registrationForm');
        if (registrationForm) {
            registrationForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!validateForm()) return;

                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('submitBtn').disabled = true;

                try {
                    const recaptchaToken = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'register' });

                    if (!recaptchaToken) throw new Error('reCAPTCHA verification failed');

                    const firstName = document.getElementById('firstName').value.trim();
                    const lastName = document.getElementById('lastName').value.trim();
                    const email = document.getElementById('registerEmail').value.trim();
                    const countryCode = document.getElementById('countryCode').value;
                    const whatsappPhone = countryCode + document.getElementById('whatsappPhone').value.trim();
                    const trackLevel = document.getElementById('trackLevel').value;
                    const marketingConsent = document.getElementById('marketingConsent').checked;
                    const dataConsent = document.getElementById('dataConsent').checked;
                    const courses = Array.from(document.querySelectorAll('input[name="courses"]:checked')).map(cb => cb.value);
                    const generatedPassword = generatePassword();

                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password: generatedPassword,
                        options: {
                            data: {
                                first_name: firstName,
                                last_name: lastName,
                                whatsapp_phone: whatsappPhone,
                                track_level: trackLevel,
                                courses,
                                marketing_consent: marketingConsent,
                                data_processing_consent: dataConsent,
                                generated_password: generatedPassword,
                                recaptcha_token: recaptchaToken,
                                topic_path: topicPath
                            }
                        }
                    });

                    if (error) throw error;

                    registrationForm.style.display = 'none';
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('registerSuccess').style.display = 'block';

                } catch (err) {
                    alert('Errore durante la registrazione: ' + err.message);
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('submitBtn').disabled = false;
                }
            });
        }
    </script>

</body>
</html>
